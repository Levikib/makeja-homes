"use client";

import { useState, useMemo } from "react";
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { Eye, Edit, FileText, Search, Calendar, AlertCircle } from "lucide-react";

interface Lease {
  id: string;
  startDate: Date;
  endDate: Date;
  monthlyRent: number;
  securityDeposit: number;
  status: string;
  terms: string | null;
  createdAt: Date;
  tenants: {
    users: {
      firstName: string;
      lastName: string;
      email: string;
    };
    units: {
      unitNumber: string;
      properties: {
        name: string;
      };
    };
  };
}

interface LeasesClientProps {
  leases: Lease[];
  properties: Array<{ id: string; name: string }>;
}

export default function LeasesClient({ leases: initialLeases, properties }: LeasesClientProps) {
  const [leases] = useState(initialLeases);
  const [searchTerm, setSearchTerm] = useState("");
  const [statusFilter, setStatusFilter] = useState("");
  const [expiryFilter, setExpiryFilter] = useState("");

  // Calculate stats
  const stats = useMemo(() => {
    const active = leases.filter((l) => l.status === "ACTIVE").length;
    const expired = leases.filter((l) => l.status === "EXPIRED").length;
    const terminated = leases.filter((l) => l.status === "TERMINATED").length;
    
    const expiringSoon = leases.filter((l) => {
      if (l.status !== "ACTIVE") return false;
      const daysUntilExpiry = Math.floor(
        (new Date(l.endDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24)
      );
      return daysUntilExpiry <= 30 && daysUntilExpiry > 0;
    }).length;

    return {
      total: leases.length,
      active,
      expired,
      terminated,
      expiringSoon,
    };
  }, [leases]);

  // Filter leases
  const filteredLeases = leases.filter((lease) => {
    const matchesSearch =
      lease.tenants.users.firstName.toLowerCase().includes(searchTerm.toLowerCase()) ||
      lease.tenants.users.lastName.toLowerCase().includes(searchTerm.toLowerCase()) ||
      lease.tenants.units.unitNumber.toLowerCase().includes(searchTerm.toLowerCase());

    const matchesStatus = !statusFilter || lease.status === statusFilter;

    const daysUntilExpiry = Math.floor(
      (new Date(lease.endDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24)
    );

    const matchesExpiry =
      !expiryFilter ||
      (expiryFilter === "expiring" && daysUntilExpiry <= 30 && daysUntilExpiry > 0) ||
      (expiryFilter === "expired" && daysUntilExpiry < 0);

    return matchesSearch && matchesStatus && matchesExpiry;
  });

  return (
    <>
      {/* Stats */}
      <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div className="group relative bg-gradient-to-br from-blue-900/20 to-cyan-900/20 border border-blue-700/30 rounded-xl p-4 hover:border-blue-500/60 transition-all hover:shadow-lg hover:shadow-blue-500/30">
          <div className="absolute inset-0 bg-gradient-to-br from-blue-600/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity" />
          <div className="flex items-center justify-between mb-1">
            <p className="text-gray-400 text-xs">Total Leases</p>
            <FileText className="w-5 h-5 text-blue-400" />
          </div>
          <p className="text-3xl font-bold text-white">{stats.total}</p>
        </div>

        <div className="group relative bg-gradient-to-br from-green-900/20 to-emerald-900/20 border border-green-700/30 rounded-xl p-4 hover:border-green-500/60 transition-all hover:shadow-lg hover:shadow-green-500/30">
          <div className="absolute inset-0 bg-gradient-to-br from-green-600/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity" />
          <div className="flex items-center justify-between mb-1">
            <p className="text-gray-400 text-xs">Active</p>
            <Calendar className="w-5 h-5 text-green-400" />
          </div>
          <p className="text-3xl font-bold text-white">{stats.active}</p>
        </div>

        <div className="group relative bg-gradient-to-br from-orange-900/20 to-yellow-900/20 border border-orange-700/30 rounded-xl p-4 hover:border-orange-500/60 transition-all hover:shadow-lg hover:shadow-orange-500/30">
          <div className="absolute inset-0 bg-gradient-to-br from-orange-600/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity" />
          <div className="flex items-center justify-between mb-1">
            <p className="text-gray-400 text-xs">Expiring Soon</p>
            <AlertCircle className="w-5 h-5 text-orange-400" />
          </div>
          <p className="text-3xl font-bold text-white">{stats.expiringSoon}</p>
        </div>

        <div className="group relative bg-gradient-to-br from-red-900/20 to-orange-900/20 border border-red-700/30 rounded-xl p-4 hover:border-red-500/60 transition-all hover:shadow-lg hover:shadow-red-500/30">
          <div className="absolute inset-0 bg-gradient-to-br from-red-600/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity" />
          <div className="flex items-center justify-between mb-1">
            <p className="text-gray-400 text-xs">Expired</p>
            <FileText className="w-5 h-5 text-red-400" />
          </div>
          <p className="text-3xl font-bold text-white">{stats.expired}</p>
        </div>

        <div className="group relative bg-gradient-to-br from-gray-900/20 to-slate-900/20 border border-gray-700/30 rounded-xl p-4 hover:border-gray-500/60 transition-all hover:shadow-lg hover:shadow-gray-500/30">
          <div className="absolute inset-0 bg-gradient-to-br from-gray-600/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity" />
          <div className="flex items-center justify-between mb-1">
            <p className="text-gray-400 text-xs">Terminated</p>
            <FileText className="w-5 h-5 text-gray-400" />
          </div>
          <p className="text-3xl font-bold text-white">{stats.terminated}</p>
        </div>
      </div>

      {/* Filters */}
      <div className="bg-gray-800/50 border border-gray-700 rounded-xl p-4 space-y-4">
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div className="lg:col-span-2">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
              <input
                type="text"
                placeholder="Search by tenant name or unit..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full pl-10 pr-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder:text-gray-500"
              />
            </div>
          </div>

          <select
            value={statusFilter}
            onChange={(e) => setStatusFilter(e.target.value)}
            className="px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
          >
            <option value="">All Status</option>
            <option value="ACTIVE">Active</option>
            <option value="EXPIRED">Expired</option>
            <option value="TERMINATED">Terminated</option>
          </select>

          <select
            value={expiryFilter}
            onChange={(e) => setExpiryFilter(e.target.value)}
            className="px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
          >
            <option value="">All Leases</option>
            <option value="expiring">Expiring Soon (30 days)</option>
            <option value="expired">Expired</option>
          </select>
        </div>
        <p className="text-gray-400 text-sm">
          Showing {filteredLeases.length} of {leases.length} leases
        </p>
      </div>

      {/* Leases List */}
      {filteredLeases.length === 0 ? (
        <div className="bg-gray-800/50 border border-gray-700 rounded-xl p-12 text-center">
          <FileText className="w-16 h-16 text-gray-600 mx-auto mb-4" />
          <p className="text-gray-400 mb-4">No leases found</p>
          <Link href="/dashboard/admin/leases/new">
            <Button className="bg-gradient-to-r from-blue-600 to-cyan-600">
              Create First Lease
            </Button>
          </Link>
        </div>
      ) : (
        <div className="space-y-3">
          {filteredLeases.map((lease) => {
            const daysUntilExpiry = Math.floor(
              (new Date(lease.endDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24)
            );
            const isExpiringSoon = daysUntilExpiry <= 30 && daysUntilExpiry > 0;
            const isExpired = daysUntilExpiry < 0;

            return (
              <div
                key={lease.id}
                className="group relative bg-gray-800/50 border border-gray-700 rounded-xl p-6 hover:border-blue-500/50 transition-all hover:shadow-lg hover:shadow-blue-500/20"
              >
                <div className="absolute inset-0 bg-gradient-to-br from-blue-600/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-xl" />
                
                <div className="relative flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center gap-3 mb-3">
                      <h3 className="text-lg font-semibold text-white">
                        {lease.tenants.users.firstName} {lease.tenants.users.lastName}
                      </h3>
                      <span
                        className={`px-3 py-1 rounded-full text-xs font-medium ${
                          lease.status === "ACTIVE"
                            ? "bg-green-500/10 text-green-400 border border-green-500/30"
                            : lease.status === "EXPIRED"
                            ? "bg-red-500/10 text-red-400 border border-red-500/30"
                            : "bg-gray-500/10 text-gray-400 border border-gray-500/30"
                        }`}
                      >
                        {lease.status}
                      </span>
                      {isExpiringSoon && (
                        <span className="px-3 py-1 rounded-full text-xs font-medium bg-orange-500/10 text-orange-400 border border-orange-500/30">
                          Expiring in {daysUntilExpiry} days
                        </span>
                      )}
                      {isExpired && (
                        <span className="px-3 py-1 rounded-full text-xs font-medium bg-red-500/10 text-red-400 border border-red-500/30">
                          Expired {Math.abs(daysUntilExpiry)} days ago
                        </span>
                      )}
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">
                      <div>
                        <p className="text-gray-400 text-xs">Property</p>
                        <p className="text-white font-semibold">
                          {lease.tenants.units.properties.name}
                        </p>
                      </div>
                      <div>
                        <p className="text-gray-400 text-xs">Unit</p>
                        <p className="text-white font-semibold">Unit {lease.tenants.units.unitNumber}</p>
                      </div>
                      <div>
                        <p className="text-gray-400 text-xs">Monthly Rent</p>
                        <p className="text-green-400 font-semibold">
                          KSH {(lease.monthlyRent || lease.rentAmount || 0).toLocaleString()}
                        </p>
                      </div>
                      <div>
                        <p className="text-gray-400 text-xs">Start Date</p>
                        <p className="text-white">{new Date(lease.startDate).toLocaleDateString()}</p>
                      </div>
                      <div>
                        <p className="text-gray-400 text-xs">End Date</p>
                        <p className="text-white">{new Date(lease.endDate).toLocaleDateString()}</p>
                      </div>
                    </div>
                  </div>

                  <div className="flex gap-2">
                    <Link href={`/dashboard/admin/leases/${lease.id}`}>
                      <Button
                        size="sm"
                        variant="outline"
                        className="border-blue-500/50 text-blue-400 hover:bg-blue-500/10"
                      >
                        <Eye className="w-4 h-4 mr-1" />
                        View
                      </Button>
                    </Link>
                    {lease.status === "ACTIVE" && (
                      <Link href={`/dashboard/admin/leases/${lease.id}/edit`}>
                        <Button
                          size="sm"
                          variant="outline"
                          className="border-purple-500/50 text-purple-400 hover:bg-purple-500/10"
                        >
                          <Edit className="w-4 h-4 mr-1" />
                          Edit
                        </Button>
                      </Link>
                    )}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}
    </>
  );
}
